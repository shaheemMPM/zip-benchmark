#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
IMPLEMENTATIONS_DIR="$PROJECT_ROOT/implementations"
RESULTS_DIR="$PROJECT_ROOT/benchmark/results"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
RUN_DIR="$RESULTS_DIR/run_$TIMESTAMP"

mkdir -p "$RUN_DIR"

all_implementations=("nodejs-jszip" "nodejs-7zip" "python-zipfile" "golang-archive-zip" "rust-zip-rs")

run_benchmark() {
    impl_dir="$1"
    impl_name="$2"
    echo "Running benchmark for $impl_name..."
    
    cd "$impl_dir"
    
    output_file="$RUN_DIR/${impl_name}_result.txt"
    { time ./benchmark; } 2>&1 | tee "$output_file"
    
    echo "Benchmark for $impl_name completed."
    echo
}

print_usage() {
    echo "Usage: ./run [OPTIONS]"
    echo "Options:"
    echo "  all                   Run benchmarks for all implementations"
    echo "  <implementation list> Run benchmarks for specific implementations"
    echo ""
    echo "Available implementations:"
    for impl in "${all_implementations[@]}"; do
        echo "  $impl"
    done
}

if [ $# -eq 0 ]; then
    print_usage
    exit 1
fi

implementations_to_run=()
if [ "$1" = "all" ]; then
    implementations_to_run=("${all_implementations[@]}")
else
    for arg in "$@"; do
        if [[ " ${all_implementations[@]} " =~ " ${arg} " ]]; then
            implementations_to_run+=("$arg")
        else
            echo "Invalid implementation: $arg"
            print_usage
            exit 1
        fi
    done
fi

for impl in "${implementations_to_run[@]}"; do
    run_benchmark "$IMPLEMENTATIONS_DIR/$impl" "$impl"
done

echo "All benchmarks completed. Results are stored in $RUN_DIR"

python "$SCRIPT_DIR/generate_report.py" "$RUN_DIR"